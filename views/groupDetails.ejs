<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= group.name %> | SpendSync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        html { scroll-behavior: smooth; }
        [id] { scroll-margin-top: 100px; }
        body { font-family: 'Inter', sans-serif; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); }
    </style>
</head>

<body class="bg-gray-50 flex h-screen overflow-hidden">

    <div class="md:hidden fixed top-0 w-full bg-white shadow-sm z-50 flex justify-between items-center p-4">
        <div class="flex items-center gap-3">
            <a href="/groups" class="text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <span class="font-bold text-gray-800 truncate max-w-[150px]"><%= group.name %></span>
        </div>
        <button onclick="toggleSidebar(true)" class="text-gray-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </div>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-[60] hidden md:hidden transition-opacity" onclick="toggleSidebar(false)"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-[70] w-64 bg-white border-r border-gray-200 transform -translate-x-full md:translate-x-0 sidebar-transition md:static md:h-screen flex-shrink-0">
        <div class="p-6 h-full flex flex-col overflow-y-auto">
            <div class="flex justify-end md:hidden mb-4"><button onclick="toggleSidebar(false)" class="text-gray-500 text-xl font-bold">‚úï</button></div>
            <div class="flex flex-col items-center mb-8">
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold mb-2">MW</div>
                <h3 class="font-bold text-gray-800"><%= user.username %></h3>
            </div>
            <nav class="space-y-2 flex-1">
                <a href="/" class="block px-6 py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">Dashboard</a>
                <a href="/income" class="block px-6 py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">Income</a>
                <a href="/expense" class="block px-6 py-3 text-gray-500 hover:bg-gray-50 rounded-xl font-medium">Expense</a>
                <a href="/groups" class="block px-6 py-3 bg-purple-600 text-white rounded-xl shadow-md font-medium">Groups</a>
            </nav>
            <a href="/logout" class="block px-6 py-3 text-gray-500 hover:text-red-500 font-medium mt-4">Logout</a>
        </div>
    </aside>

    <main id="mainContainer" class="flex-1 w-full p-4 pt-20 md:p-8 md:pt-8 overflow-y-auto h-full">
        <% 
            const isAdmin = group.createdBy.toString() === currentUser.toString();
            let myRecord = settlementData.find(s => s.userId.toString() === currentUser.toString());
            let toGive = myRecord && myRecord.netBalance < 0 ? Math.abs(myRecord.netBalance) : 0;
            let toGet = myRecord && myRecord.netBalance > 0 ? myRecord.netBalance : 0;
            
            let totalGroupExpense = 0;
            let myPersonalShare = 0;
            let memberSpendingMap = {};
            let descriptionSpendingMap = {};

            expenses.forEach(exp => {
                if(!exp.isSettlement) {
                    totalGroupExpense += exp.totalAmount;
                    let mySplit = exp.splits.find(s => s.user.toString() === currentUser.toString());
                    if(mySplit) myPersonalShare += mySplit.amount;
                    memberSpendingMap[exp.paidBy.username] = (memberSpendingMap[exp.paidBy.username] || 0) + exp.totalAmount;
                    descriptionSpendingMap[exp.description || "Misc"] = (descriptionSpendingMap[exp.description || "Misc"] || 0) + exp.totalAmount;
                }
            });
        %>

        <header class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="hidden md:block text-3xl font-bold text-gray-800"><%= group.name %></h2>
                <form action="/groups/<%= group._id %>/delete" method="POST" onsubmit="return confirm('Action required: Admin deletes group, Member leaves group.')">
                    <button type="submit" class="px-5 py-2.5 rounded-xl border-2 <%= isAdmin ? 'border-red-100 text-red-600' : 'border-gray-200 text-gray-600' %> font-bold text-sm">
                        <%= isAdmin ? 'Delete Group' : 'Leave Group' %>
                    </button>
                </form>
            </div>

            <div class="flex flex-wrap gap-2 mb-8 sticky top-0 z-30 bg-gray-50/80 backdrop-blur-md py-4">
                <a href="#memberSection" class="bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg text-[10px] md:text-xs font-bold shadow-sm hover:border-purple-500 hover:text-purple-600 transition-all">Members</a>
                <a href="#chartSection" class="bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg text-[10px] md:text-xs font-bold shadow-sm hover:border-purple-500 hover:text-purple-600 transition-all">Analytics</a>
                <a href="#expenseFormSection" class="bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg text-[10px] md:text-xs font-bold shadow-sm hover:border-purple-500 hover:text-purple-600 transition-all">Add Expense</a>
                <a href="#historySection" class="bg-white border border-gray-200 text-gray-700 px-3 py-2 rounded-lg text-[10px] md:text-xs font-bold shadow-sm hover:border-purple-500 hover:text-purple-600 transition-all">History</a>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stat-card bg-white p-4 md:p-6 rounded-3xl border border-red-100">
                    <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest">To Give</p>
                    <p class="text-lg md:text-2xl font-black text-red-600">‚Çπ<%= toGive.toFixed(2) %></p>
                </div>
                <div class="stat-card bg-white p-4 md:p-6 rounded-3xl border border-green-100">
                    <p class="text-[10px] font-bold text-green-400 uppercase tracking-widest">To Get</p>
                    <p class="text-lg md:text-2xl font-black text-green-600">‚Çπ<%= toGet.toFixed(2) %></p>
                </div>
                <div class="stat-card bg-white p-4 md:p-6 rounded-3xl border border-purple-100">
                    <p class="text-[10px] font-bold text-purple-400 uppercase tracking-widest">Share</p>
                    <p class="text-lg md:text-2xl font-black text-purple-600">‚Çπ<%= myPersonalShare.toFixed(2) %></p>
                </div>
                <div class="stat-card bg-gray-800 p-4 md:p-6 rounded-3xl">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total</p>
                    <p class="text-lg md:text-2xl font-black text-white">‚Çπ<%= totalGroupExpense.toFixed(2) %></p>
                </div>
            </div>

            <div id="chartSection" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Paid By Member</h4>
                    <div class="h-48 md:h-64"><canvas id="spendingChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">By Category</h4>
                    <div class="h-48 md:h-64"><canvas id="descriptionChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-4">Personal share</h4>
                    <div class="h-48 md:h-64"><canvas id="personalChart"></canvas></div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 pb-10">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-3xl border-2 border-purple-500 shadow-sm">
                    <h3 class="font-bold text-purple-600 mb-4 text-xs uppercase">Required Settlements</h3>
                    <div class="space-y-3">
                        <% 
                            let debtors = settlementData.filter(m => m.netBalance < -0.01).map(m => ({...m, bal: Math.abs(m.netBalance)}));
                            let creditors = settlementData.filter(m => m.netBalance > 0.01).map(m => ({...m, bal: m.netBalance}));
                            let paymentPaths = [];
                            while(debtors.length > 0 && creditors.length > 0) {
                                let d = debtors[0], c = creditors[0];
                                let amt = Math.min(d.bal, c.bal);
                                paymentPaths.push({ from: d.username, fromId: d.userId, to: c.username, toId: c.userId, amount: amt.toFixed(2) });
                                d.bal -= amt; c.bal -= amt;
                                if(d.bal < 0.01) debtors.shift();
                                if(c.bal < 0.01) creditors.shift();
                            }
                        %>
                        <% paymentPaths.forEach(path => { %>
                            <div class="bg-purple-50 p-4 rounded-2xl flex justify-between items-center">
                                <span class="text-xs font-bold"><%= path.from %> ‚ûú <%= path.to %></span>
                                <div class="flex flex-col items-end">
                                    <span class="text-lg font-black text-purple-700">‚Çπ<%= path.amount %></span>
                                    <% if (path.fromId.toString() === currentUser.toString()) { %>
                                        <button onclick="openSettleModal('<%= path.toId %>', '<%= path.to %>', '<%= path.amount %>')" class="text-[10px] uppercase font-bold text-purple-600 underline">Record Payment</button>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>

                <div id="memberSection" class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                    <h3 class="font-bold text-gray-400 mb-4 text-xs uppercase">Members</h3>
                    <form id="addMemberForm" class="flex gap-2 mb-4">
                        <input id="memberUsername" type="text" placeholder="Username" required class="flex-1 border rounded-xl px-4 py-2 text-sm outline-none">
                        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-xl font-bold">+</button>
                    </form>
                    <div id="memberList" class="flex flex-wrap gap-2">
                        <% group.members.forEach(m => { %>
                            <span class="bg-white text-gray-700 px-3 py-1.5 rounded-full text-xs font-semibold border border-gray-200 flex items-center gap-2 shadow-sm">
                                <%= m.username %>
                                <% if (group.createdBy.toString() === m._id.toString()) { %>
                                    <span class="bg-black text-white text-[8px] px-1 rounded uppercase">Admin</span>
                                <% } %>
                                <% if (group.createdBy.toString() === currentUser.toString() && m._id.toString() !== currentUser.toString()) { %>
                                    <button onclick="handleRemoveMember('<%= m._id %>', '<%= group.createdBy %>')" class="text-gray-400 hover:text-red-500 font-bold ml-1">‚úï</button>
                                <% } %>
                            </span>
                        <% }) %>
                    </div>
                </div>

                <div id="expenseFormSection" class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                    <h3 class="font-bold text-gray-400 mb-4 text-xs uppercase">New Expense</h3>
                    <form action="/groups/<%= group._id %>/add-expense" method="POST" class="space-y-4">
                        <input name="description" type="text" placeholder="Description" required class="w-full border rounded-xl px-4 py-3 text-sm">
                        <input name="amount" type="number" step="0.01" placeholder="Amount (‚Çπ)" required class="w-full border rounded-xl px-4 py-3 text-sm">
                        <select name="splitType" id="splitType" class="w-full border rounded-xl px-4 py-3 bg-gray-50 text-sm">
                            <option value="equal">Split Equally</option>
                        </select>
                        <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3.5 rounded-xl shadow-lg">Add Expense</button>
                    </form>
                </div>
            </div>

            <div id="historySection" class="xl:col-span-2">
                <div class="bg-white rounded-3xl border border-gray-100 overflow-hidden shadow-sm">
                    <div class="p-6 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-xl">History</h3>
                        <input type="text" id="descSearch" onkeyup="filterHistory()" placeholder="Search..." class="px-4 py-2 border rounded-xl text-sm outline-none">
                    </div>
                    <div class="divide-y divide-gray-50 overflow-y-auto max-h-[800px]">
                        <% if (expenses && expenses.length > 0) { %>
                            <% expenses.slice().reverse().forEach(exp => { %>
                                <div class="expense-row group hover:bg-gray-50 transition" data-desc="<%= (exp.description || '').toLowerCase() %>">
                                    <div class="p-6 flex justify-between items-center">
                                        <a href="/groups/<%= group._id %>/expense/<%= exp._id %>" class="min-w-0 flex-1 pr-4">
                                            <h4 class="font-bold text-gray-800 truncate group-hover:text-purple-600 transition"><%= exp.isSettlement ? "ü§ù Settlement" : exp.description %></h4>
                                            <p class="text-[10px] md:text-xs text-gray-400 mt-1"><%= new Date(exp.date).toDateString() %> ‚Ä¢ Paid by <%= exp.paidBy.username %></p>
                                        </a>
                                        <div class="flex items-center gap-4">
                                            <span class="text-sm md:text-lg font-black">‚Çπ<%= exp.totalAmount.toLocaleString('en-IN') %></span>
                                            <% if (exp.paidBy._id.toString() === currentUser.toString()) { %>
                                                <form action="/groups/<%= group._id %>/expense/<%= exp._id %>/delete" method="POST">
                                                    <button class="text-gray-300 hover:text-red-500 font-bold transition">‚úï</button>
                                                </form>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="p-20 text-center text-gray-400">No transactions recorded yet.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="settleModal" class="fixed inset-0 bg-black/40 z-[100] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl relative mx-4">
            <button onclick="closeSettleModal()" class="absolute top-4 right-4 text-gray-400 font-bold">‚úï</button>
            <h3 class="text-xl font-bold mb-1">Confirm Payment</h3>
            <p id="settleTargetText" class="text-xs text-purple-600 font-bold mb-6 uppercase"></p>
            <form action="/groups/<%= group._id %>/settle" method="POST" class="space-y-4">
                <input type="hidden" name="paidToId" id="modalPaidToId">
                <input name="amount" id="modalAmount" type="number" step="0.01" required class="w-full border-2 border-purple-100 rounded-xl px-4 py-3 text-lg font-black text-purple-600 outline-none">
                <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3.5 rounded-xl">Confirm Settlement</button>
            </form>
        </div>
    </div>

    <script>
        function toggleSidebar(show) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full', !show);
            overlay.classList.toggle('hidden', !show);
        }

        // CHARTS LOGIC
        const mData = <%- JSON.stringify(memberSpendingMap) %>;
        const dData = <%- JSON.stringify(descriptionSpendingMap) %>;
        const chartConfig = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 }}} } };

        new Chart(document.getElementById('spendingChart'), {
            type: 'doughnut',
            data: { labels: Object.keys(mData), datasets: [{ data: Object.values(mData), backgroundColor: ['#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6'], borderWidth: 0 }]},
            options: chartConfig
        });

        new Chart(document.getElementById('descriptionChart'), {
            type: 'bar',
            data: { labels: Object.keys(dData), datasets: [{ label: 'Spent', data: Object.values(dData), backgroundColor: '#8b5cf6', borderRadius: 8 }]},
            options: { ...chartConfig, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 8 } }}} }
        });

        new Chart(document.getElementById('personalChart'), {
            type: 'pie',
            data: { labels: ['You', 'Others'], datasets: [{ data: [<%= myPersonalShare %>, <%= Math.max(0, totalGroupExpense - myPersonalShare) %>], backgroundColor: ['#7c3aed', '#e5e7eb'], borderWidth: 0 }]},
            options: chartConfig
        });

        function filterHistory() {
            const q = document.getElementById('descSearch').value.toLowerCase();
            document.querySelectorAll('.expense-row').forEach(row => {
                row.style.display = row.dataset.desc.includes(q) ? "block" : "none";
            });
        }

        function openSettleModal(id, name, amt) {
            document.getElementById('modalPaidToId').value = id;
            document.getElementById('modalAmount').value = amt;
            document.getElementById('settleTargetText').innerText = `Settling to ${name}`;
            document.getElementById('settleModal').classList.remove('hidden');
        }
        function closeSettleModal() { document.getElementById('settleModal').classList.add('hidden'); }

        // Check for "Unsettled" error when trying to leave
window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    
    if (params.get('error') === 'unsettled') {
        Toastify({
            text: `‚ö†Ô∏è Cannot leave! You have a pending balance of ‚Çπ${params.get('amount')}`,
            duration: 5000,
            gravity: "top", 
            position: "center",
            style: {
                background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                borderRadius: "12px",
                fontWeight: "bold",
                boxShadow: "0 10px 15px -3px rgba(0, 0, 0, 0.1)"
            }
        }).showToast();
        
        // Clean the URL so the toast doesn't reappear on refresh
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

    </script>
</body>
</html>